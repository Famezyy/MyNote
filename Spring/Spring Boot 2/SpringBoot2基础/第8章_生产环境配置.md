# 第8章_生产环境配置

## 1.profile功能

Spring Boot 默认会加载配置文件`application.yaml`，可以指定环境配置文件`application-{env}.yaml`，例如`application-prod.yaml`。

激活该配置文件时，可以通过配置文件激活：`spring.profiles.active=prod`，或者命令行激活：`java -jar xxx.jar --spring.profiles.active=prod`，命令行优先。如果与默认配置文件重复，则会覆盖默认配置文件。

### 1.1 @Profile条件装配功能

可在类、属性、方法上标注，指定什么环境下生效。

```java
@Profile(value = {"prod", "default"})
public class ProductionConfiguration {}
```

### 1.2 分组

```properties
spring.profiles.group.production[0] = proddb
spring.profiles.group.production[1] = prodmq
# 同时激活一个组内的所有配置文件
spring.profiles.active = production 
```

## 2.外部化配置

### 2.1 外部配置源

java 属性文件、YAML 文件、环境变量、命令行参数。

### 2.2 配置文件查找位置

- classpath 根路径
- classpath 根路径下 config 目录
- jar 包当前目录
- jar 包当前目录的 config 目录
- /config 子目录的直接子目录

### 2.3 属性加载顺序

1. Default properties (specified by setting `SpringApplication.setDefaultProperties`).
2. [`@PropertySource`](https://docs.spring.io/spring-framework/docs/5.3.21/javadoc-api/org/springframework/context/annotation/PropertySource.html) annotations on your `@Configuration` classes. Please note that such property sources are not added to the `Environment` until the application context is being refreshed. This is too late to configure certain properties such as `logging.*` and `spring.main.*` which are read before refresh begins.
3. Config data (such as `application.properties` files).
4. A `RandomValuePropertySource` that has properties only in `random.*`.
5. OS environment variables.
6. Java System properties (`System.getProperties()`).
7. JNDI attributes from `java:comp/env`.
8. `ServletContext` init parameters.
9. `ServletConfig` init parameters.
10. Properties from `SPRING_APPLICATION_JSON` (inline JSON embedded in an environment variable or system property).
11. Command line arguments.
12. `properties` attribute on your tests. Available on [`@SpringBootTest`](https://docs.spring.io/spring-boot/docs/2.7.1/api/org/springframework/boot/test/context/SpringBootTest.html) and the test annotations for testing a particular slice of your application.
13. [`@TestPropertySource`](https://docs.spring.io/spring-framework/docs/5.3.21/javadoc-api/org/springframework/test/context/TestPropertySource.html) annotations on your tests.
14. Devtools global settings properties in the `$HOME/.config/spring-boot` directory when devtools is active.

### 2.4 配置文件加载顺序

1. 当前 jar 包内部的 application.properties 和 application.yaml
2. 当前 jar 包内部的 application-{env}.properties 和 application-{env}.yaml
3. 引用的外部 jar 包的 application.properties 和 application.yaml
4. 引用的外部 jar 包的 pplication-{env}.properties 和 application-{env}.yaml

## 3.原理

```java
public class SpringApplication {
    public static ConfigurableApplicationContext run(Class<?>[] primarySources, String[] args) {
        // 创建 SpringApplication
        // 执行 run()
        return (new SpringApplication(primarySources)).run(args);
    }
}
```

创建`SpringApplication`时会通过`SpringFactoriesLoader`加载`META-INF/spring.factories`下的资源。

执行`run()`：

```java
public class SpringApplication {
    public ConfigurableApplicationContext run(String... args) {
        long startTime = System.nanoTime();
        // 创建引导上下文（context 环境）bootstrapContext
        DefaultBootstrapContext bootstrapContext = this.createBootstrapContext();
        ConfigurableApplicationContext context = null;
        // 设置 headless 模式
        this.configureHeadlessProperty();
        // 获得所有运行监听器
        SpringApplicationRunListeners listeners = this.getRunListeners(args);
        // 通知监听器服务正在启动
        listeners.starting(bootstrapContext, this.mainApplicationClass);

        try {
            // 保存命令行参数
            ApplicationArguments applicationArguments = new DefaultApplicationArguments(args);
            // 准备环境（添加 ConversionService 等）
            ConfigurableEnvironment environment = this.prepareEnvironment(listeners, bootstrapContext, applicationArguments);
            this.configureIgnoreBeanInfo(environment);
            Banner printedBanner = this.printBanner(environment);
            // 创建 IOC 容器（AnnotationConfigServletWebServerApplicationContext）
            context = this.createApplicationContext();
            context.setApplicationStartup(this.applicationStartup);
            // 准备 IOC 容器的基本信息，会调用 ApplicationContextInitializer 的 initialize()
            this.prepareContext(bootstrapContext, context, environment, listeners, applicationArguments, printedBanner);
            // 刷新 IOC 容器
            this.refreshContext(context);
            this.afterRefresh(context, applicationArguments);
            Duration timeTakenToStartup = Duration.ofNanos(System.nanoTime() - startTime);
            if (this.logStartupInfo) {
                (new StartupInfoLogger(this.mainApplicationClass)).logStarted(this.getApplicationLog(), timeTakenToStartup);
            }

            listeners.started(context, timeTakenToStartup);
            // 调用所有 runners
            // 获取容器中的 ApplicationRunner、CommandLineRunner，并按照 @Order 进行排序，最后执行
            this.callRunners(context, applicationArguments);
        } catch (Throwable var12) {
            this.handleRunFailure(context, var12, listeners);
            throw new IllegalStateException(var12);
        }

        try {
            Duration timeTakenToReady = Duration.ofNanos(System.nanoTime() - startTime);
            // 通知准备完成
            listeners.ready(context, timeTakenToReady);
            return context;
        } catch (Throwable var11) {
            this.handleRunFailure(context, var11, (SpringApplicationRunListeners)null);
            throw new IllegalStateException(var11);
        }
    }
}
```

