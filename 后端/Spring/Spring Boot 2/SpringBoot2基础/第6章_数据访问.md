# 第6章_数据访问

## 1.SQL

### 1.1 数据源的自动配置

导入JDBC场景

```xml
<dependency>
	<groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jdbc</artifactId>
</dependency>
```

导入数据库驱动

```xml
<dependency>
	<groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
</dependency>
```

修改配置项

```yaml
spring:
	datasource:
		url: jdbc:mysql//localhost:3306/db_name
		username: root
		password: 123456
```

测试

```java
jdbcTemplate.queryForObject("select * from account");
Long aLong = jdbcTemplate.queryForObject("select count(*) from account", Long.class);
```

原理

`DataSourceAutoConfiguration`：数据源的自动配置

- 修改数据源相关的配置：`spring.datasource`

- 底层配置好的连接池：`HikariDataSource`，只有当容器中没有连接池时才会注册

  ```java
  @Configuration(proxyBeanMethods = false)
  @EnableConfigurationProperties(DataSourceProperties.class)
  public class DataSourceAutoConfiguration {
      @Configuration(proxyBeanMethods = false)
  	@Conditional(PooledDataSourceCondition.class)
  	@ConditionalOnMissingBean({ DataSource.class, XADataSource.class })
  	@Import({ DataSourceConfiguration.Hikari.class, DataSourceConfiguration.Tomcat.class,
  			DataSourceConfiguration.Dbcp2.class, DataSourceConfiguration.OracleUcp.class,
  			DataSourceConfiguration.Generic.class, DataSourceJmxConfiguration.class })
  	protected static class PooledDataSourceConfiguration {
  
  	}
  }
  ```

`DataSourceTransactionManagerAutoConfiguration`：事务管理器的自动配置

`JdbcTemplateAutoConfiguration`：JdbcTemplate 的自动配置，通过导入 JdbcTemplateConfiguration 注册了 JdbcTemplate 组件

- 修改 JdbcTemplate 的相关配置：`spring.jdbc`（设置 queryTimeout 等）

`JndiDataSourceAutoConfiguration`：jndi 的自动配置

`XADataSourceAutoConfiguration`：分布式事务相关的自动配置

### 1.2 使用Druid数据源

#### 1.自定义整合

导入 alibaba 的 druid 数据源

```xml
<dependency>
	<groupId>com.alibaba</groupId>
    <aritifactId>druid</aritifactId>
</dependency>
```

配置数据源

```yaml
spring:
	datasource:
		url: jdbc:mysql//localhost:3306/db_name
		username: root
		password: 123456
```

注册数据源

```java
@ConfigurationProperties("spring.datasource")
public DataSource dataSource() {
    return new DruidDataSource();
}
```

**StatViewServlet**

提供监控信息展示的 html 页面，提供监控信息的 JSON API。

导入组件

```java
@Configuration
public class MyDataSourceConfig {
    @Bean
    public ServletRegistrationBean<StatViewServlet> statViewServlet() {
        StatViewServlet statViewServlet = new StatViewServlet();
        ServletRegistrationBean<StatViewServlet> servletRegistrationBean = new ServletRegistrationBean<>(statViewServlet, "/druid/*");
        servletRegistrationBean.addInitParameter("loginUsername", "admin");
        servletRegistrationBean.addInitParameter("loginPassword", "123456");
        // 是否允许清空统计数据
        servletRegistrationBean.addInitParameter("resetEnable", true);
        return servletRegistrationBean;
    }
}
```

**StatFilter**

用于统计监控信息，如 SQL 监控，URI 监控。

导入组件

```java
@Bean
public DataSource dataSource() {
    DruidDataSource druidDataSource = new DruidDataSource();
    // 可以设置多个 filter
    druidDataSource.setFilters("stat,slf4j");
    return druidDataSource;
}
```

> **所有的Filter**
>
> | 别名          | Filter类名                                              |
> | ------------- | ------------------------------------------------------- |
> | default       | com.alibaba.druid.filter.stat.StatFilter                |
> | stat          | com.alibaba.druid.filter.stat.StatFilter                |
> | mergeStat     | com.alibaba.druid.filter.stat.MergeStatFilter           |
> | encoding      | com.alibaba.druid.filter.encoding.EncodingConvertFilter |
> | log4j         | com.alibaba.druid.filter.logging.Log4jFilter            |
> | log4j2        | com.alibaba.druid.filter.logging.Log4j2Filter           |
> | slf4j         | com.alibaba.druid.filter.logging.Slf4jLogFilter         |
> | commonlogging | com.alibaba.druid.filter.logging.CommonsLogFilter       |
>
> **慢SQL记录配置**
>
> ```java
> @Bean
> public StatFilter statFilter() {
>     StatFilter statFilter = new StatFilter();
>     statFilter.setSlowSqlMillis(10000);
>     statFilter.setLogSlowSql(true);
> }
> ```

#### 2.使用官方starter

导入依赖

```xml
<dependency>
	<groupId>com.alibaba</groupId>
    <artifactId>druid-spring-boot-starter</artifactId>
</dependency>
```

配置

- 配置项：`spring.datasource.druid`
- `DruidSpringAopConfiguration`：监控 SpringBean 的配置项，`spring.datasource.druid.aop-petterns`
- `DruidStatViewServletConfiguration`：监控页的配置，`spring.datasource.druid.stat-view-servlet`
- `DruidWebStatFilterConfiguration`：web 监控配置，`spring.datasource.druid.web-stat-filter`
- `DruidFilterConfiguration`：Druid 的 filter 的配置

例：

```yaml
spring:
	datasource:
		url: jdbc:mysql://localhost:3306/db_name
		username: root
		password: 123456
		driver-class-name: com.mysql.jdbc.Driver
	druid:
		aop-patterns: com.youyi.zhao.*
		filters: stat, wall # stat: sql 监控；wall：防火墙
		
		stat-view-servlet: # 配置监控页
			enabled: true
			login-username: admin
			login-password: admin
			resetEnable: false
		
		web-stat-filter: # 监控 web
			enabled: true
            urlPattern: /*
            exclusions: '*.js,*.gif,*.jpg,*.css,*.ico,/druid/*'
            
        filter:
        	stat:
        		slow-sql-millis: 1000
        		logSlowSql: true
        		enabled: true
        	wall:
        		enabled: true
        		config:
        			drop-table-allow: false
```

### 1.3 整合MyBatis操作

引入依赖

```xml
<dependency>
	<groupId>org.mybatis.spring.boot</groupId>
    <artifactId>mybatis-spring-boot-starter</artifactId>
</dependency>
```

自动配置分析

自动配置了`SqlSessionFactory`、`SqlSession`，之需要编写`@Mapper`的注解就会被自动扫描进来（使用`@MapperScan(package)`）。

```java
@Configuration
@ConditionalOnClass({SqlSessionFactory.class, SqlSessionFactoryBean.class})
@ConditionalOnSingleCandidate(DataSource.class)
@EnableConfigurationProperties({MybatisProperties.class})
@AutoConfigureAfter({DataSourceAutoConfiguration.class, MybatisLanguageDriverAutoConfiguration.class})
public class MybatisAutoConfiguration implements InitializingBean {
```

**配置**

```yaml
mybatis:
	config-location: classpath:mybatis/mybatis-config.xml # 全局配置文件
	mapper-locations: classpath:mybatis/mapper/*.xml # sql 映射文件
```

全局配置文件

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration
	PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
	<settings>
        <!-- 开启驼峰命名规则 -->
    	<setting name="mapUnderscoreToCamelCase", value="true" />
    </settings>
</configuration>
```

也可以直接在 properties 文件中开启

```yaml
mybatis:
	# config-location: classpath:mybatis/mybatis-config.xml
	configuration:
		map-underscore-to-camel-case: true # 不能与全局配置文件共存
```

**例子**

1. 映射文件方式

   编写 mapper 接口

   ```java
   @Mapper
   public interface AccountMapper {
       public Account getAccount(Long id);
   }
   ```

   编写 sql 映射文件

   ```xml
   <?xml version="1.0" encoding="UTF-8" ?>
   <!DOCTYPE configuration
   	PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
   	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
   <mapper namespace="com.youyi.zhao.mapper.AccountMapper">
   	<select id="getAccount" resultType="com.youyi.zhao.bean.Account">
       	select * from account_tbl where id = #{id}
       </select>
   </mapper>
   ```

2. 注解方式（不推荐）

   ```java
   @Mapper
   public interface AccountMapper {
       @Select("select * from account_tbl where id = #{id}")
       public Account getAccount(Long id);
   }
   ```

3. 混合模式

   ```java
   @Mapper
   public interface AccountMapper {
       @Select("select * from account_tbl where id = #{id}")
       public Account getAccount(Long id);
       // @Insert("insert into city(name, state, country) values(#{name}, #{state}, #{country})")
       // Options(useGeneratedKeys=true keyProperty="id")
       public void insert(City city);
   }
   ```

   ```xml
   <?xml version="1.0" encoding="UTF-8" ?>
   <!DOCTYPE configuration
   	PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
   	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
   <mapper namespace="com.youyi.zhao.mapper.AccountMapper">
   	<select id="insert" useGeneratedKeys="true" keyProperty="id">
       	insert into city(name, state, country) values(#{name}, #{state}, #{country})
       </select>
   </mapper>
   ```

### 1.4 整合MyBatis-Plus

引入依赖

```xml
<dependency>
	<groupId>com.baomidou</groupId>
    <artifactId>mybatis-plus-boot-starter</artifactId>
</dependency>
```

自动配置分析

- `MybatisPlusAutoConfiguration`配置类，`mybatis-plus`为配置项
- `SqlSessionFactory`、`SqlSessionTemplate`等都配置好了
- 默认映射文件的扫描路径是`classpath:*/mapper/**/*.xml`，任意包的类路径下的所有 mapper 文件夹下的任意路径下的 xml 会被识别加载
- 可以使用`@MapperScan(package)`注解扫描`@Mapper`接口

### 1.5 动态配置多数据源

**添加依赖**

```xml
<dependency>
    <groupId>org.mybatis.spring.boot</groupId>
    <artifactId>mybatis-spring-boot-starter</artifactId>
    <version>2.1.3</version>
</dependency>
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
    <scope>runtime</scope>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-aop</artifactId>
    <version>2.7.5</version>
</dependency>
```

底层核心组件是抽象类`AbstractRoutingDataSource`，他有一个成员 map 变量`resolvedDataSources`，根据不同的 key，配置不同的数据源。所以我们要做的就是实现这个类，重写`determineCurrentLookupKey()`方法。

```java
public class DynamicDataSource extends AbstractRoutingDataSource {
    @Override
    protected Object determineCurrentLookupKey() {
        return DataSourceContextHolder.getKey();
    }
}

/**
 * 辅助类，用于存储上下文信息，线程安全
 */
public class DataSourceContextHolder {

    public static ThreadLocal<String> key = new ThreadLocal<>();

    public static void setKey(String key) {
        DataSourceContextHolder.key.set(key);
    }

    public static String getKey() {
        return key.get();
    }

    public static void clearKey() {
        key.remove();
    }
}
```

**配置类**

```java
@Configuration
public class DataSourceConfig {

    /**
     *配置数据源1
     */
    @ConfigurationProperties("datasource1")
    @Bean
    public DataSource dataSource1() {
        return DataSourceBuilder.create().build();
    }

    /**
     *配置数据源2
     */
    @ConfigurationProperties("datasource2")
    @Bean
    public DataSource dataSource2() {
        return DataSourceBuilder.create().build();
    }

    /**
     *配置 dynamicDataSource，设置数据源的 key 和 value，以及默认的数据源
     */
    @Bean
    public DynamicDataSource dynamicDataSource() {
        Map<Object, Object> targetDataSources = new HashMap<>();
        targetDataSources.put("ds1", dataSource1());
        targetDataSources.put("ds2", dataSource2());

        DynamicDataSource dynamicDataSource = new DynamicDataSource();
        dynamicDataSource.setTargetDataSources(targetDataSources);
        dynamicDataSource.setDefaultTargetDataSource(dataSource1());
        return dynamicDataSource;
    }

    /**
     * 配置 sqlSessionFactoryBean 的数据源
     */
    @Bean
    public SqlSessionFactoryBean sqlSessionFactoryBean() throws IOException {
        SqlSessionFactoryBean sqlSessionFactoryBean = new SqlSessionFactoryBean();

        /** 设置 mybatis configuration 扫描路径 */
        PathMatchingResourcePatternResolver resolver = new PathMatchingResourcePatternResolver();
        sqlSessionFactoryBean.setMapperLocations(resolver.getResources("classpath:mapper/*.xml"));

        /** 设置数据源 */
        sqlSessionFactoryBean.setDataSource(dynamicDataSource());

        return sqlSessionFactoryBean;
    }

    /**
     * 配置事务下的数据源
     */
    @Bean
    public PlatformTransactionManager transactionManager() {
        return new DataSourceTransactionManager(dynamicDataSource());
    }
}
```

**注解**

```java
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.METHOD)
@Documented
public @interface UsingDataSource {

    String value() default "";
}
```

**切面类**

```java
@Aspect
@Component
public class DataSourceAspect {

    @Pointcut("@annotation(com.example.demo.config.UsingDataSource)")
    public void checkPointCut(){}

    @Before("checkPointCut()")
    public void checkBefore(JoinPoint joinPoint) {
        UsingDataSource usingDataSource = ((MethodSignature) joinPoint.getSignature()).getMethod().getAnnotation(UsingDataSource.class);
        String dataSourceKey = usingDataSource.value();
        DataSourceContextHolder.setKey(dataSourceKey);
    }

    @After("checkPointCut()")
    public void checkAfter() {
        DataSourceContextHolder.clearKey();
    }
}
```

**mapper**

```java
@Mapper
public interface UserMapper {
    public User getById(int id);
}
```

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.dao.UserMapper">
    <select id="getById" resultType="com.example.demo.model.User">
        select * from user where userId = #{id}
    </select>
</mapper>
```

**配置文件**

```properties
datasource1.username=root
datasource1.password=root
datasource1.jdbcUrl=jdbc:mysql://localhost:3306/datasource1?allowPublicKeyRetrieval=true
datasource1.driverClassName=com.mysql.jdbc.Driver

datasource2.username=root
datasource2.password=root
datasource2.jdbcUrl=jdbc:mysql://localhost:3306/datasource2?allowPublicKeyRetrieval=true
datasource2.driverClassName=com.mysql.jdbc.Driver
```

**入口类**

```java
/** 配出数据源的自动配置类 */
@SpringBootApplication(exclude = {DataSourceAutoConfiguration.class})
/** 手动指定 mapper.class 路径 */
@MapperScan(basePackages = "com.example.demo.dao")
/** 开启 aspectJ */
@EnableAspectJAutoProxy
public class DemoApplication {

    public static void main(String[] args) {
        SpringApplication.run(DemoApplication.class, args);
    }

}
```

## 2.NoSQL

引入依赖

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-aop</artifactId>
    <version>2.7.5</version>
</dependency>
```

自动配置分析

- `RedisAutoConfiguration`配置类，配置项为`spring.redis`
- 连接工厂：`LettuceConnectionConfiguration`、`JedisConnectionConfiguration`
- 自动注入了`RedisTemplate<Object, Object>`、`StringRedisTemplate`：k、v 都是 String

切换至 Jedis

```xml
<dependency>
	<groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>

<dependency>
	<groupId>redis.clients</groupId>
    <artifactId>jedis</artifactId>
</dependency>
```

```yaml
spring:
	redis:
		host:
		port: 6379
		password:
		client-type: jedis
		jedis:
			pool:
				max-act: 10
```

**例子**

```java
ValueOperations<String, String> operations = redisTemplate.opsForValue();
operaions.set("hello", "world");
String hello = operations.get("hello");
```



