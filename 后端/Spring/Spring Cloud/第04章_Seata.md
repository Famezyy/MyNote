# 第04章_Seata

Seata 是一种开源的分布式事务解决方案，提供了 AT、TCC、SAGA 和 XA 事务模式，主要使用的是 AT 模式。阿里云上有商用的 GTS 服务。

官网：http://seata.io/zh-cn/index.html

## 1.常见的分布式事务解决方案

- Seata 分布式事务框架 - AT
- 消息队列 - TCC（Try-Confirm-Cancel）
- Saga
- XA

他们有一个共同点，都是“两阶段提交 - 2PC”，即把提交分为两个阶段：Prepare 和 Commit。

- 首先引入一个**协调者**管理各个参与者

- Prepare 阶段

  - 在事务开始时，协调者会向参与者发送 Prepare 请求

  - 各个参与者会检查各自的事务执行条件是否满足，并准备事务的业务操作
  - 如果协调者收到任一参与者的`ack:NO`应答后，会发送 rollback 请求

- Commit 阶段
  - 当协调者收到所有参与者的`ack:YES`应答后，会发送 Commit 请求
  - 参数者收到 Commit 请求后，会提交事务，并释放事务资源，成功后返回应答

### 1.1 2PC的问题

1. 同步阻塞，参与者在等待协调者的指令时，其实是在等待其他参与者的响应，在此过程中，参与者是无法进行其他操作的，也就是阻塞了其运行。 倘若参与者与协调者之间网络异常导致参与者一直收不到协调者信息，那么会导致参与者一直阻塞下去。

2. 单点 在 2PC 中，一切请求都来自协调者，所以协调者的地位是至关重要的，如果协调者宕机，那么就会使参与者一直阻塞并一直占用事务资源。

   如果协调者也是分布式，使用选主方式提供服务，那么在一个协调者挂掉后，可以选取另一个协调者继续后续的服务，可以解决单点问题。但是，新协调者无法知道上一个事务的全部状态信息（例如已等待 Prepare 响应的时长等），所以也无法顺利处理上一个事务。

3. 数据不一致 Commit 事务过程中 Commit/Rollback 请求可能因为协调者宕机或协调者与参与者网络问题丢失，那么就导致了部分参与者没有收到 Commit/Rollback 请求，而其他参与者则正常收到执行了 Commit/Rollback 操作，没有收到请求的参与者则继续阻塞。这时，参与者之间的数据就不再一致了。

   当参与者执行 Commit/Rollback 后会向协调者发送 Ack，然而协调者不论是否收到所有的参与者的 Ack，该事务也不会再有其他补救措施了，协调者能做的也就是等待超时后像事务发起者返回一个“我不确定该事务是否成功”。

4. 环境可靠性依赖协调者 Prepare 请求发出后，等待响应，然而如果有参与者宕机或与协调者之间的网络中断，都会导致协调者无法收到所有参与者的响应，那么在 2PC 中，协调者会等待一定时间，然后超时后，会触发事务中断，在这个过程中，协调者和所有其他参与者都是出于阻塞的。这种机制对网络问题常见的现实环境来说太苛刻了。

### 1.2 AT 模式

AT 模式是两阶段提交协议的演变，在 AT 模式下，用户只需关注业务 SQL。

- 一阶段：生成事务的二阶段提交和回滚操作
- 二阶段：
  - 提交异步化，非常快速地完成
  - 回滚通过一阶段的回滚日志进行反向补偿