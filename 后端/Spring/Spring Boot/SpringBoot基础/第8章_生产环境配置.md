# 第8章_生产环境配置

## 1.profile配置文件

Spring Boot 默认**总是会**加载配置文件 `application.yaml`，可以指定环境配置文件 `application-{env}.yaml`，例如 `application-prod.yaml`，激活时如果发生了冲突则会覆盖 `application.yaml` 的配置项。

## 2.@Profile条件装配

可在**类**、**属性**、**方法**上标注，指定什么环境下生效。

```java
@Profile(value = {"prod", "default"})
public class ProductionConfiguration {}
```

## 3.激活方式

1. 配置文件激活（只能声明在 `application.yaml` 中）：`spring.profiles.active=prod,default`
2. 命令行激活：`java -jar xxx.jar --spring.profiles.active=prod`

都可同时指定多个环境，但是总是**命令行优先**：如果与默认配置文件重复，则会覆盖默认配置文件。

> **注意**
>
> 默认情况下只激活 `default` 环境，：`spring.profiles.active=default`。
>
> 如果配置了激活其他环境则 `default` 环境参数会失效，需要同时主动配置激活 `default`。

### 3.1 分组

```properties
spring.profiles.group.production[0] = proddb
spring.profiles.group.production[1] = prodmq
# 同时激活一个组内的所有配置文件
spring.profiles.active = production
```

### 3.2 包含

无论激活哪个环境，总是会生效包含的环境。

```properties
spring.profiles.include=default
```

生效的环境=激活的环境/默认的环境 + 包含的环境。

## 4.外部化配置

### 4.1 外部配置源

java 属性文件、YAML 文件、环境变量、命令行参数。

### 4.2 配置文件查找顺序

后面覆盖前面：

1. classpath 根路径
2. classpath 根路径下 `/config` 目录
3. jar 包当前目录
4. jar 包当前目录的 `/config` 目录
5. jar 包当权目录的 `/config` 子目录的直接子目录

### 4.3 属性加载顺序

后面覆盖前面：

1. **默认属性**（通过 `SpringApplication.setDefaultProperties` 指定的）

2. `@PropertySource` 指定加载的配置（需要写在 `@Configuration` 类上才可生效）

3. 配置文件（`application.properties/yml` 等）

4. RandomValuePropertySource 支持的 `random.*` 配置（如：`@Value("${random.int}")`）

5. OS 环境变量

6. Java 系统属性（`System.getProperties()`）

7. JNDI 属性（来自 java:comp/env）

8. ServletContext 初始化参数

9. ServletConfig 初始化参数

10. SPRING_APPLICATION_JSON属性（内置在环境变量或系统属性中的 JSON）

11. 命令行参数

    所有参数均可由命令行传入，使用 `--参数项=参数值`，将会被添加到环境变量中，并优先于**配置文件**。比如`java -jar app.jar --name="Spring"`，可以使用 `@Value("${name}")` 获取。

12. 测试属性。（`@SpringBootTest` 进行测试时指定的属性）

13. 测试类 `@TestPropertySource` 注解

14. Devtools 设置的全局属性（`$HOME/.config/spring-boot`）

### 4.4 配置文件加载顺序

后面覆盖前面：

1. 当前 jar 包内部的 application.properties 和 application.yaml
2. 当前 jar 包内部的 application-{env}.properties 和 application-{env}.yaml
3. 引用的外部 jar 包的 application.properties 和 application.yaml
4. 引用的外部 jar 包的 application-{env}.properties 和 application-{env}.yaml

> **注意**
>
> 如果 `.properties` 和 `.yml` 同时存在,则 `.properties` 优先。

