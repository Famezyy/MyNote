# 状态机

## 1.引入 pom 依赖

```xml
<dependency>
    <groupId>org.springframework.statemachine</groupId>
    <artifactId>spring-statemachine-core</artifactId>
    <version>2.1.3.RELEASE</version>
</dependency>
<dependency>
    <!-- 用于分布式环境下将状态存储在 redis 中 -->
    <groupId>org.springframework.statemachine</groupId>
    <artifactId>spring-statemachine-redis</artifactId>
    <version>1.2.9.RELEASE</version>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
```

## 2.创建POJO

```java
@Data
public class Order implements Serializable {
    String orderId;
    OrderState orderState;
}
```

```java
public enum OrderState {
    WAIT_PAY,
    WAIT_SEND,
    WAIT_RECEIVE,
    FINISH
}
```

```java
public enum OrderStateChangeAction {
    // 待支付到待发货的转化状态
    PAY_ORDER,
    // 待发货到待接收的转化状态
    SEND_ORDER,
    // 待接收到待完成的转化状态
    RECEIVE_ORDER
}
```

## 3.OrderStateListener

```java
@Component
@WithStateMachine(name = "orderStateMachine")
public class OrderStateListener {

    @Autowired
    private RedisTemplate<Object, Object> redisTemplate;


    @OnTransition(source="WAIT_PAY", target="WAIT_SEND")
    public boolean payToSend(Message<OrderStateChangeAction> message) {
        // 从 redis 中获取订单，判断是否为待支付
        Order order = (Order) message.getHeaders().get("order");
        if (order.getOrderState() != OrderState.WAIT_PAY) {
            throw new UnsupportedOperationException("Order state error");
        }
        // 支付逻辑
        // 支付成功后修改订单状态待发货，更新redis缓存
        order.setOrderState(OrderState.WAIT_SEND);
        redisTemplate.opsForValue().set(order.getOrderId(), order);
        return true;
    }

    @OnTransition(source="WAIT_SEND", target="WAIT_RECEIVE")
    public boolean sendToReceive(Message<OrderStateChangeAction> message) {
        // 从 redis 中获取订单，判断是否为待支付
        Order order = (Order) message.getHeaders().get("order");
        if (order.getOrderState() != OrderState.WAIT_SEND) {
            throw new UnsupportedOperationException("Order state error");
        }
        // 支付逻辑
        // 支付成功后修改订单状态待发货，更新redis缓存
        order.setOrderState(OrderState.WAIT_RECEIVE);
        redisTemplate.opsForValue().set(order.getOrderId(), order);
        return true;
    }
}
```

## 4.OrderStateMachineConfig

```java
@Configuration
@EnableStateMachine(name="orderStateMachine")
public class OrderStateMachineConfig extends StateMachineConfigurerAdapter<OrderState, OrderStateChangeAction> {

    @Override
    public void configure(StateMachineStateConfigurer<OrderState, OrderStateChangeAction> states) throws Exception {
        // 初始化状态
        states.withStates().initial(OrderState.WAIT_PAY).states(EnumSet.allOf(OrderState.class));
    }

    @Override
    public void configure(StateMachineTransitionConfigurer<OrderState, OrderStateChangeAction> transitions) throws Exception {
        transitions.withExternal().source(OrderState.WAIT_PAY).target(OrderState.WAIT_SEND).event(OrderStateChangeAction.PAY_ORDER).and()
                .withExternal().source(OrderState.WAIT_SEND).target(OrderState.WAIT_RECEIVE).event(OrderStateChangeAction.SEND_ORDER).and()
                .withExternal().source(OrderState.WAIT_RECEIVE).target(OrderState.FINISH).event(OrderStateChangeAction.RECEIVE_ORDER);
    }

    @Bean(name = "stateMachineRedisPersister")
    public RedisStateMachinePersister<OrderState, OrderStateChangeAction> getRedisPersister(RedisConnectionFactory redisConnectionFactory) {
        RedisStateMachineContextRepository<OrderState, OrderStateChangeAction> redisStateMachineContextRepository = new RedisStateMachineContextRepository<>(redisConnectionFactory);
        RepositoryStateMachinePersist<OrderState, OrderStateChangeAction> repositoryStateMachinePersist = new RepositoryStateMachinePersist<>(redisStateMachineContextRepository);
        return new RedisStateMachinePersister<>(repositoryStateMachinePersist);
    }

}
```

## 5.Controller

```java
@RestController
public class OrderController {

    @Autowired
    private StateMachine<OrderState, OrderStateChangeAction> stateMachine;

    @Autowired
    private RedisTemplate<Object, Object> redisTemplate;

    @RequestMapping("/order")
    public String order() {
        String orderId = UUID.randomUUID().toString();
        Order order = new Order();
        order.setOrderId(orderId);
        order.setOrderState(OrderState.WAIT_PAY);
        redisTemplate.opsForValue().set(orderId, order);
        return order.getOrderId();
    }

    @RequestMapping("/pay")
    public void pay(String orderId) {
        try {
            stateMachine.start();
            Order order = (Order) redisTemplate.opsForValue().get(orderId);
            Message<OrderStateChangeAction> message = MessageBuilder.withPayload(OrderStateChangeAction.PAY_ORDER).setHeader("order", order).build();
            stateMachine.sendEvent(message);
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            stateMachine.stop();
        }
    }

    @RequestMapping("send")
    public void send(String orderId) {
        try {
            stateMachine.start();
            Order order = (Order) redisTemplate.opsForValue().get(orderId);
            Message<OrderStateChangeAction> message = MessageBuilder.withPayload(OrderStateChangeAction.SEND_ORDER).setHeader("order", order).build();
            stateMachine.sendEvent(message);
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            stateMachine.stop();
        }
    }
}
```

