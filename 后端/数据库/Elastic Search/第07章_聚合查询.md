# 第07章_聚合查询

## 1.概述

### 1.1 基本概念

在 Elasticsearch 中，**聚合查询**是一种分析和统计数据的功能。聚合查询能够处理大量的数据，执行各种统计分析，如计算总数、平均值、最大值、最小值、标准差等等，并生成相应的报告。

### 1.2 使用场景

聚合查询可以用于各种场景，比如商业智能、数据挖掘、日志分析等等。

- 电商平台的销售分析：统计每个地区的销售额、每个用户的消费总额、每个产品的销售量等，以便更好地了解销售情况和趋势
- 社交媒体的用户行为分析：统计每个用户的发布次数、转发次数、评论次数等，以便更好地了解用户行为和趋势，同时可以将数据按照地区、时间、话题等维度进行分析
- 物流企业的运输分析：统计每个区域的运输量、每个车辆的运输次数、每个司机的行驶里程等，以便更好地了解运输情况和优化运输效率
- 金融企业的交易分析：统计每个客户的交易总额、每个产品的销售量、每个交易员的业绩等，以便更好地了解交易情况和优化业务流程
- 智能家居的设备监控分析：统计每个设备的使用次数、每个家庭的能源消耗量、每个时间段的设备使用率等，以便更好地了解用户需求和优化设备效能

### 1.3 基本语法

聚合查询的语法结构与其他查询相似，通常包含以下部分：

- **查询条件**：指定需要聚合的文档，可以使用标准的 Elasticsearch 查询语法，如 `term`、`match`、`range` 等等
- **聚合函数**：指定要执行的聚合操作，如 `sum`、`avg`、`min`、`max`、`terms`、`date_histogram` 等等，每个聚合命令都会生成一个聚合结果
- **聚合嵌套**：聚合命令可以嵌套，以便更细粒度地分析数据

```json
GET <index_name>/_search
{
    "aggs": {
        "<aggs_name>": { // 聚合名称需要自己定义
            "<agg_type>": {
                "field": "<field_name>"
            }
        }
    }
}
```

- `aggs_name`：聚合函数的名称
- `agg_type`：聚合种类，比如是桶聚合（`terms`）或者是指标聚合（`avg`、`sum`、`min`、`max` 等）
- `field_name`：字段名称或者叫域名

## 2.三种类型的聚合

### 2.1 桶聚合：Bucket Aggregations

类比 SQL 中的 `group by` 的作用，主要用于统计不同类型数据的数量。在 Elasticsearch 中，桶聚合是一种常用的聚合查询操作，它将文档分为多个“桶”，然后在每个桶上进行统计分析。

#### 1.使用场景

桶聚合可以用于各种场景，例如：

- 对数据进行分组统计，比如按照地区、年龄段、性别等字段进行分组统计
- 对时间序列数据进行时间段分析，比如按照每小时、每天、每月、每季度、每年等时间段进行分析
- 对各种标签信息分类，并统计其数量

#### 2.基本语法

**（1）按照字段名称分类**

将航班信息按 "Carrier" 字段名进行聚合

```json
get kibana_sample_data_flights/_search
{
  "aggs": {
    "carrier_group": {
      "terms": {
        "field": "Carrier" // 注意如果是文本类型，要使用 keyword 类型
      }
    }
  }
}
```

结果

```json
{
    ...
    "hits": {...},
    "aggregations": {
        "carrier_group": {
            "doc_count_error_upper_bound": 0,
            "sum_other_doc_count": 0,
            // 分桶数据
            "buckets": [
                {
                    "key": "Logstash Airways",
                    "doc_count": 3323
                },
                {
                    "key": "JetBeats",
                    "doc_count": 3261
                },
                {
                    "key": "Kibana Airlines",
                    "doc_count": 3219
                },
                {
                    "key": "ES-Air",
                    "doc_count": 3211
                }
            ]
        }
    }
}
```

可以发现这组数据中 Carrier 共有 4 种。

**（2）按照字段值区间分类**

将航班信息按 "DistanceMiles" 字段进行区间聚合

```json
get kibana_sample_data_flights/_search
{
    "aggs": {
        "DistanceMiles_range": {
            "range": {
                "field": "DistanceMiles",
                "ranges": [
                    {
                        "to": 5000
                    },
                    {
                        "to": 10000
                    },
                    {
                        "from": 10000
                    }
                ]
            }
        }
    }
}
```

- `from`：闭区间
- `to`：开区间

结果

```json
"DistanceMiles_range": {
    "buckets": [
        {
            // 5000 以下的有 7296 个
            "key": "*-5000.0",
            "to": 5000,
            "doc_count": 7296
        },
        {
            // 5000~10000 的有 12574 个
            "key": "*-10000.0",
            "to": 10000,
            "doc_count": 12574
        },
        {
            // 10000 以上的有 440 个
            "key": "10000.0-*",
            "from": 10000,
            "doc_count": 440
        }
    ]
}
```

#### 3.聚合多个字段

当在聚合的时候需要对多个字段同时聚合的时候，可以使用 `multi_terms` 来完成。

**示例**

先按航空公司聚合，再按航班号聚合。

```json
get kibana_sample_data_flights/_search
{
    "aggs": {
        "Carrier_FlightNum_group": {
            "multi_terms": {
                "terms": [
                    {
                        "field": "Carrier"
                    },
                    {
                        "field": "FlightNum"
                    }
                ]
            }
        }
    }
}
```

### 2.2 指标聚合：Metrics Aggregations

#### 1.使用场景

用于统计某个指标，如最大值、最小值、平均值，可以结合桶聚合一起使用，如按照商品类型分桶，统计每个桶的平均价格。

#### 2.基本语法

分别统计商品价格的最大值、最小值和平均值。

```json
GET goods/_search
{
    "aggs": {
        "max_price": {
            "max": {
                "field": "price"
            }
        },
        "min_price": {
            "min": {
                "field": "price"
            }
        },
        "avg_price": {
            "avg": {
                "field": "price"
            }
        }
    }
}
```

- 平均值：`avg`
- 最大值：`max`
- 最小值：`min`
- 求和：`sum`
- 数量：`value_count`
- 详细信息（显示所有信息）：`stats`

### 2.3 管道聚合：Pipeline Aggregations

管道聚合用于对聚合的结果进行二次聚合，如要统计绑定数量最多的标签 bucket，就是要先按照标签进行分桶，再在分桶的结果上计算最大值。