Jenkins 是一款自动化拉取、集成、构建、测试的管理系统。

## 1.安装部署

首先创建三台虚拟机，分别作为 Gitlab 服务器、测试服务器和 Jenkins 服务器。

### 1.1 安装Gitlab

官方网站：https://about.gitlab.com

中文安装文档：https://gitlab.cn/install/

安装至少需要 6 G内存。

#### 1.在SSH下安装

**安装依赖**

```bash
sudo yum install -y curl policycoreutils-python openssh-server perl
sudo systemctl enable sshd
sudo systemctl start sshd
```

**配置镜像**

```bash
curl -fsSL https://packages.gitlab.cn/repository/raw/scripts/setup.sh | /bin/bash
```

**开始安装**

```bash
sudo EXTERNAL_URL = "http://192.168.11.100" yum install -y gitlab-jh
```

除非指定密码，否则会生成一个默认密码并存储在`/etc/gitlab/initial_root_password`文件夹（会在 24 小时后被`gitlab-ctl reconfigure`自动删除，因此建议初始登录成功后立即修改初始密码 -- 在管理员选项处更改密码）。使用用户名`root`和密码登陆。

#### 2.在Docker下安装

**设置卷位置**

在设置其他所有内容之前，请配置一个新的环境变量 `$GITLAB_HOME`，指向配置、日志和数据文件所在的目录。 确保该目录存在并且已授予适当的权限。

对于 Linux 用户，将路径设置为 `/srv/gitlab`

```
export GITLAB_HOME=/srv/gitlab
```

极狐 GitLab 容器使用主机装载的卷来存储持久数据

| 本地位置              | 容器位置          | 使用                        |
| :-------------------- | :---------------- | :-------------------------- |
| `$GITLAB_HOME/data`   | `/var/opt/gitlab` | 用于存储应用程序数据        |
| `$GITLAB_HOME/logs`   | `/var/log/gitlab` | 用于存储日志                |
| `$GITLAB_HOME/config` | `/etc/gitlab`     | 用于存储极狐GitLab 配置文件 |

创建一个 `docker-compose.yml` 文件

```yaml
version: '3.6'
services:
  web:
    image: 'registry.gitlab.cn/omnibus/gitlab-jh:latest'
    restart: always
    hostname: 'gitlab'
    ports:
      - '80:80'
      - '443:443'
      - '22:22' # 注意不要端口冲突，22 端口用于 SSH 连接
    volumes:
      - '$GITLAB_HOME/config:/etc/gitlab'
      - '$GITLAB_HOME/logs:/var/log/gitlab'
      - '$GITLAB_HOME/data:/var/opt/gitlab'
    shm_size: '256m'
```

确保您在与 `docker-compose.yml` 相同的目录下并启动极狐 GitLab

```
docker compose up -d
```

#### 3.常用命令

```bash
# 启动所有组件
gitlab-ctl start
# 停止所有的组件
gitlab-ctl stop
# 重启所有 gitlab 组件
gitlab-ctl restart
# 查看服务状态
gitlab-ctl statue
# 启动服务
gitlab-ctl reconfigure
# 修改默认的配置文件
vi /etc/gitlab/gitlab.rb
# 查看日志
gitlab-ctl tail
```

#### 4.新建项目

新建空白项目 - 填写项目名称、提交 URL - 新建

### 1.2 安装Jenkins

中文文档：https://www.jenkins.io/zh/doc/book/installing/

#### 1.利用yum安装

```bash
sudo wget -O /etc/yum.repos.d/jenkins.repo \
    https://pkg.jenkins.io/redhat-stable/jenkins.repo
sudo rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key
sudo yum upgrade
# Add required dependencies for the jenkins package
sudo yum install java-11-openjdk
sudo yum install jenkins
sudo systemctl daemon-reload
```

>   **提示**
>
>   `sudo update-alternatives --config java`可以用来切换默认 java 环境

启动 Jenkins

```bash
sudo systemctl enable jenkins
sudo systemctl start jenkins
```

#### 2.利用war包安装

-   安装 JDK 运行环境

    ```bash
    sudo yum upgrade
    sudo yum install java-11-openjdk
    ```

-   下载 war 包并上传至服务器

-   执行 war 包：`java -jar jenkins.war`

#### 3.安装Maven

https://maven.apache.org/download.cgi

下载 Binary tar.gz 包并上传至服务器

解压并执行：`tar -zxvf apachi-maven-x.x.x-bin.tar.gz `

复制到其他地方：`mv apachi-maven-x.x.x /usr/local/maven`

>   **修改阿里云镜像**
>
>   打开`settings.xml`，修改一下地方
>
>   ```xml
>   <mirror>
>     <id>alimaven</id>
>     <mirrorOf>central</mirrorOf>
>     <name>aliyun maven</name>
>     <url>http://maven.aliyun.com/nexus/content/repositories/central/</url>
>   </mirror>
>   ```
>
>   同时可以在配置文件中修改下本次仓库地址：
>
>   ```xml
>   <localRepository>D:\Maven\repository</localRepository>
>   ```
>
>   maven 全局 jdk 版本：
>
>   ```xml
>   <profile>
>     <id>jdk-1.8</id>
>     <activation>
>       <activeByDefault>true</activeByDefault>
>       <jdk>1.8</jdk>
>     </activation>
>     <properties>
>       <maven.compiler.source>1.8</maven.compiler.source>
>       <maven.compiler.target>1.8</maven.compiler.target>
>       <maven.compiler.compilerVersion>1.8</maven.compiler.compilerVersion>
>     </properties>
>   </profile>
>   ```

#### 4.安装Git

```bash
yum install -y git
```

#### 5.访问

访问`localhost:8080`，安装推荐的插件

重启

## 2.快速开始

### 2.1 打包Maven项目

Manage Jenkins - Manage Plugins - Available Plugins - 选择 Maven Integration - install without restart

回到主页 - 新建 Item - 选择 Maven

编辑`Configure`：

-   `源码管理` 

    -   勾选 git - 输入仓库 URL 确实是否正常连接（需要提前在 Jenkins 主机上安装 git）

        >   **配置SSH**
        >
        >   -   在 Jenkins 服务器上切换到 Jenkins 用户：`sudo su -s /bin/bash jenkins`
        >   -   生成 SSH key：`ssh-keygen -o`
        >   -   访问 Gitlab 服务器：`ssh root@192.168.11.100`

    -   指定要拉取的分支

-   `Pre Steps`

    指定前置处理，可以用来做些前置清理，例如可以编写一个脚本用来清除之前启动的服务：

    ```bash
    #!/bin/bash
    
    # 删除历史数据
    rm -rf ~/microservice
    
    # 以下代码会获取传入的参数
    appname = $1
    if [ -z $appname ];
    	exit 1;
    # 然后找到启动的信息中带该参数的 java 程序并得到第二个字符串（pid）
    pid = `ps-ef | grep $appname | grep 'java -jar' | awk '{printf $2}'`
    
    # 使用 -z 做空值判断
    if [ -z $pid ]；
    	then
    		echo "$appname not started"
    	else
    		kill -9 $pid
    		echo "$appname stoping..."
    fi
    
    check = `ps -ef | grep -w $pid | grep java`
    if [ -z $check ];
    	then
    		echo "$appname pid:$pid stopped"
    	else
    		echo "$appname stop failed"
    ```

-   `Build`

    指定正确的 POM 文件地址

    >   **配置SSH**
    >
    >   -   在 Jenkins 服务器上切换到 Jenkins 用户：`sudo su -s /bin/bash jenkins`
    >   -   生成 SSH key：`ssh-keygen -o`
    >   -   访问 Gitlab 服务器：`ssh root@192.168.11.100`

回到 Dashboard 主页，点击运行

观察控制台输出：构建执行状态 - 选择相应的任务

### 2.2 将JAR包发送到测试服务器

安装插件：`Publish Over SSH`

在`Configure System`中添加测试服务器：

-   最下面找到`Publish over SSH`
-   新增`SSH Servers`
-   填写`Name`、`Hostname`、`Username`
-   选择高级选项`Use password authentication`
-   填写密码
-   `Test Configuration`测试是否能连接上

在上一节的基础上继续编辑`Configure`：

-   `Post Steps`

    -   选择`Send files or execute commandfs over SSH`
    -   选择之前配好的`SSH Server`
    -   指定`Source file`，例如：`**/*SNAPSHOT.jar`
    -   指定`Remove prefix`，例如：`/target`
    -   指定`Remote directory`，例如：`/microservice`（此相当于放在`~/microservice`下）

    >   按照以上的配置，最终 JAR 会被放在`~/microservice`中

-   `Exec command`

    指定执行的命令，例如：`nohub java -jar ~/microservice/*SNAPSHOT.jar >mylog.log 2>&1 &`

    （不要指定阻塞命令，否则 Jinkens 最后执行完后会一直阻塞直到超时）

    >   **数据流重定向**
    >
    >   数据流重定向就是将某个命令执行后应该要出现在屏幕上的数据传输到其他地方
    >
    >   -   标准输入（stdin）：代码为 0，使用`<`或`<<`
    >   -   标准输出（stdout）：代码为 1，使用`>`或`>>`
    >   -   标准错误输出（stderr）：代码为 2，使用`2>`或`2>>`
    >   -   `>`：覆盖写
    >   -   `>>`：追加写

回到 Dashboard 主页，点击运行
