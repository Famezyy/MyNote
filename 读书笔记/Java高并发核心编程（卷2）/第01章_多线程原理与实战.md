# 第01章_多线程原理与实战

## 1.进程和线程

计算机处理任务的调度单位就是进程和线程。

### 1.1 进程的基本原理

**进程是程序的一次启动执行**，程序就是存放在硬盘中的可执行文件，主要包括代码指令和数据。**一个进程是操作系统将程序装入内存，给程序分配必要的系统资源，并开始运行程序的指令**。同一个程序则可以多次启动，对应多个线程。

在计算机中，CPU 是核心的硬件资源，承担了所有的计算任务；内存资源承担了运行时数据的保存任务；外存资源（硬盘等）承担了数据外部永久存储的任务。其中，计算任务的调度、资源的分配由操作系统来统领。应用程序以进程的形式运行于操作系统之上，享受操作系统提供的服务。

一般来说，一个进程由**程序段**、**数据段**和**进程控制块**三部分组成，大致结构如下：

<img src="img/%E7%AC%AC01%E7%AB%A0_%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E6%88%98/image.png" alt="进程的大致结构" style="zoom: 50%;" />

程序段也一般被称为代码段。代码段是进程的程序指令在内存中的位置，包含需要执行的指令集合；数据段是进程的操作数据在内存中的位置，包含需要操作的数据集合；程序控制块包含进程的描述信息和控制信息，是进程存在的唯一标志。

程序控制块（Program Control Block，PCB）主要由四大部分组成：

1. 进程的描述信息
   
   主要包括：进程 ID 和进程名称，进程 ID 是唯一的，代表进程的身份；进程状态，比如运行、就绪、阻塞；进程优先级，是进程调度的重要依据。

2. 进程的调度信息
   
   主要包括：程序起始地址，程序的第一行指令的内存地址；通信信息，进程间通信时的消息队列。

3. 进程的资源信息
   
   主要包括：内存信息，内存占用情况和内存管理所用的数据结构；I/O 设备信息，所用的 I/O 设备编号及相应的数据结构；文件句柄，所打开文件的信息。

4. 进程上下文
   
   主要包括执行时各种 CPU 寄存器的值、当前程序计数器的值以及各种栈的值等，即进程的环境。在操作系统切换进程时，当前进程被迫让出 CPU，当前进程的上下文就保存在 PCB 结构中，供下次恢复运行时使用。

现代操作系统中，进程是并发执行的，任何进程都可以同其他进程一起执行。在进程内部，代码段和数据段有自己的独立地址空间，不同进程的地址空间是相互独立的。

Java 编写的程序都运行在 Java JVM 虚拟机中，每当使用 Java 命令启动一个 Java 应用程序时，就会启动一个 JVM 进程。在这个 JVM 进程内部，所有 Java 程序代码都是以线程来运行的。JVM 找到程序的入口点`main()`方法，然后运行`main()`方法，这样就产生了一个线程，这个线程被称为**主线程**。当`main()`方法结束后主线程运行完成，JVM 进程也随即退出。

### 1.2 线程的基本原理

早期的操作系统中只有进程而没有线程。进程是程序执行和系统进行并发调用的最小单位。随着 CPU 性能的提升，为了充分利用 CPU，同时弥补进程调度过于笨重产生的问题，进程内部演进出了并发调度的诉求，于是就发明了线程。**线程是指"进程代码段"的一次顺序执行流程**。线程是 CPU 调度的最小单位。一个进程可以有一个或多个线程，各个线程之间共享进程的内存空间、系统资源，进程仍然是操作系统资源分配的最小单位。

Java 程序的进程执行过程就是标准的多线程的执行过程。每当使用 Java 命令执行一个 class 类时，实际上就是启动了一个 JVM 进程。理论上，在该进程的内部至少会启动两个线程，一个是 main 线程，另一个是 GC 线程。但是实际上执行一个 Java 程序后启动的线程远远不止 2 个。

一个标准的线程主要由三部分组成，即**线程描述信息**、**程序计数器**和**栈内存**，如下图所示。

![Alt text](img/%E7%AC%AC01%E7%AB%A0_%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E6%88%98/image-1.png)

在线程的结构中，线程描述信息即线程的基本信息，主要包括：

1. 线程 ID（线程标识符），是线程的唯一标识，同一个进程内不同线程的 ID 不会重叠。
2. 线程名称，如果没有指定则系统自动分配一个。
3. 线程优先级，优先级越高获得 CPU 的执行机会越大。
4. 线程状态，为新建、就绪、运行、阻塞、结束等状态中的一种

而程序计数器负责记录线程下一条指令的代码段内存地址。栈内存则是代码段中局部变量的存储空间，各个线程间独立。在 JDK 8 中，每个线程创建时默认分配 1MB 大小的栈内存。

在 Java 中，执行程序流程的重要单位是"方法"，而栈内存的分配单位是"栈帧"，**方法的每一次执行都需要为其分配一个栈帧，栈帧主要保存该方法中的局部变量、方法的返回地址以及其他方法的相关信息**。当线程的执行流程进入方法时，JVM 就会为方法分配一个对应的栈帧压入栈内存；当线程的执行流程跳出方法时，JVM 就从栈内存弹出该方法的栈帧，此时方法帧的局部变量的内存空间就会被回收。

### 1.3 进程与线程的区别



